---
title: "Time Series"
author: "Brayan Duran Medina"
output: html_document
---

### Monthly beer production in Australia from 1956 to 1995

# Importing libraries
```{r, message=FALSE}
library(readxl)
library(dplyr)
library(ggplot2)
library(GGally)
library(ggcorrplot)
library(MASS)
library(lmtest)
library(forecast)
library(tseries)
library(Hmisc)
library(lubridate)
```

# Reading data
```{r}
data <- read.csv("monthly-beer-production-in-austr.csv",
                 header = TRUE, sep = ",")
head(data)
```

# Preparing data
```{r}
names(data)[1] <- "Date"
names(data)[2] <- "Value"

title <- "Monthly beer production in Australia"

data$Value <- as.numeric(data$Value)
data$Date <- as.Date(as.yearmon(data$Date, format = "%Y-%m"))

head(data)
```

# Creating time series
```{r}
time_series <- ts(data = data$Value, start =
                    as.numeric(c(format(data$Date[1], "%Y"),
                                 format(data$Date[1], "%m"))), freq = 12)
```

# Plotting data
```{r}
plot(time_series, type = "l", ylab = title, col = "red")

grid()
```

### Notes:
We have too many years in the data, so the forecast will be very inaccurate. 
So then we will only use the data from 1975 to 1995, that is the last 20 years.

# Cutting data to keep only the last 20 years
```{r}
data <- data[format(data$Date, "%Y") >= 1975, ]
```

# Creating new time series with the last 20 years
```{r}
time_series <- ts(data = data$Value, start =
                    as.numeric(c(format(data$Date[1], "%Y"),
                                 format(data$Date[1], "%m"))), freq = 12)
```

# Plotting new time series
```{r}
plot(time_series, type = "l", ylab = title, col = "red")

grid()
```

# STL decomposition
```{r, fig.width=10, fig.height=10}
plot(stl(time_series, s.window = "periodic"))
```

# Box-Cox transformation
```{r, fig.width=10, fig.height=10}
par(mfrow = c(2, 1))

plot(time_series, ylab = "Original series", xlab = "", col = "red")
grid()

lambda <- BoxCox.lambda(time_series)

plot(BoxCox(time_series, lambda),
     ylab = "Transformed series", xlab = "", col = "red")

title(main = toString(round(lambda, 3)))

grid()
```

### Notes:
Looking at the plot of the original series and the transformed one, we can see that there is not so much variance in the date, 
so we will not make the Box-Cox transformation.

# ARIMA

## Automatic model selection
```{r, echo=FALSE, cache=TRUE}
fit_auto <- auto.arima(time_series, biasadj = TRUE)

fit_auto
```

### Notes:
The automatic model selection gives us an ARIMA(4,0,5)(1,1,2)[12] model.

## Plot of residuals
```{r, fecho=FALSE, fig.width=10, fig.height=6}
res_auto <- residuals(fit_auto)

plot(res_auto)
```

```{r, echo=FALSE, fig.width=10, fig.height=6}
par(mfrow = c(1, 2))

qqnorm(res_auto)

qqline(res_auto, col = "red")

hist(res_auto)
```

Hypothesis   | Test         | Result         | P-value
------------ | ------------ | -------------- | ------------------------------
Normality    | Shapiro-Wilk |     rejected   | `r shapiro.test(res_auto)$p.value`
Unbiasedness | Wilcoxon     | not rejected   | `r wilcox.test(res_auto)$p.value`
Stationarity | KPSS         | not rejected   | `r kpss.test(res_auto)$p.value`